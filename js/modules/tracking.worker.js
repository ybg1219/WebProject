self.importScripts("../../mediapipe/vision_bundle.cjs");const{FilesetResolver,PoseLandmarker}=self.tasks.vision;let poseLandmarker=null,offscreenCanvas=null,offctx=null;async function initPoseLandmarker(e,s){const a=await FilesetResolver.forVisionTasks(e);poseLandmarker&&poseLandmarker.close(),poseLandmarker=await PoseLandmarker.createFromOptions(a,{baseOptions:{modelAssetPath:s},runningMode:"VIDEO",numPoses:2}),console.log("Worker: PoseLandmarker initialized."),self.postMessage({type:"READY"})}self.onmessage=async e=>{const{type:s}=e.data;try{if("INIT"===s){const{canvas:s,wasmPath:a,modelPath:o}=e.data;offscreenCanvas=s,offctx=offscreenCanvas.getContext("2d"),await initPoseLandmarker(a,o)}else if("DETECT"===s){if(!poseLandmarker)return console.error("Worker: PoseLandmarker not initialized."),void self.postMessage({type:"RESULT",payload:null});const{frame:s,timestamp:a}=e.data;if(0===s.width||0===s.height)return console.warn("Worker skipped empty frame"),s.close(),void self.postMessage({type:"RESULT",payload:null});offctx.drawImage(s,0,0,offscreenCanvas.width,offscreenCanvas.height);const o=await poseLandmarker.detectForVideo(offscreenCanvas,a);s.close(),self.postMessage({type:"RESULT",payload:o})}}catch(e){console.error("Worker detection error:",e),self.postMessage({type:"ERROR",payload:{message:e.message,stack:e.stack}})}};